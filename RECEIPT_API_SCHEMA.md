# Receipt Generation API Schema

## Overview
This document defines the request schema for generating transaction receipts in the SellSync POS system. The receipt should be generated after a successful checkout and include all transaction details.

---

## API Endpoint (Suggested)
```
POST /api/receipts/generate
```

---

## Request Schema

### TypeScript Interface
```typescript
interface ReceiptGenerationRequest {
  // Transaction Metadata
  transaction: {
    transactionId?: string;        // Optional: Auto-generated by backend if not provided
    timestamp: string;              // ISO 8601 format: "2025-12-11T10:30:00.000Z"
    storeId?: string;               // Optional: Store/Location identifier
    posTerminalId?: string;         // Optional: POS terminal identifier
    employeeId?: string;            // Optional: Employee who processed the sale
    employeeName?: string;          // Optional: Employee name
  };

  // Customer Information (Optional - from CustomerDetailsModal)
  customer: {
    name?: string;                  // Customer full name
    phone?: string;                 // Customer phone number
    email?: string;                 // Customer email address
    address?: string;               // Customer address
    notes?: string;                 // Order notes/preferences
    customerId?: string;            // Optional: Customer ID if registered
  } | null;

  // Ring-Up Items (from Redux RingUpSlice)
  items: Array<{
    id?: string;                    // Product ID (if available)
    name: string;                   // Product name
    qty: number;                    // Quantity purchased
    product_price: number;          // Unit price
    tax_percentage?: number;        // Tax percentage for this item
    tax_amount?: number;            // Calculated tax for this item
    discount?: number;              // Item-level discount (if any)
    subtotal: number;               // qty * product_price
    total: number;                  // Subtotal + tax - discount
    barcode?: string;               // Product barcode
    sku?: string;                   // Product SKU
    category?: string;              // Product category
    imageUrl?: string;              // Product image URL
  }>;

  // Checkout/Payment Details (from CheckoutModal)
  payment: {
    method: "cash" | "card" | "online" | "qr";  // Payment method selected
    subtotal: number;               // Total before tax and discount
    tax: number;                    // Total tax amount
    discount: {
      amount: number;               // Discount amount
      isPercentage: boolean;        // Whether discount is percentage or fixed
      percentage?: number;          // If percentage, the percentage value
    };
    total: number;                  // Final total amount
    totalItems: number;             // Total number of items
    tendered?: number;              // Amount tendered (for cash payments)
    change?: number;                // Change given (for cash payments)
    cardLast4?: string;             // Last 4 digits of card (for card payments)
    cardBrand?: string;             // Card brand (Visa, Mastercard, etc.)
    transactionReference?: string;  // Payment gateway transaction reference
  };

  // Receipt Preferences
  receipt: {
    emailReceipt: boolean;          // Whether to email the receipt
    printReceipt?: boolean;         // Whether to print physical receipt
    format?: "pdf" | "html" | "thermal";  // Receipt format
  };
}
```

---

## JSON Example

```json
{
  "transaction": {
    "timestamp": "2025-12-11T14:35:22.000Z",
    "storeId": "STORE_001",
    "posTerminalId": "POS_TERMINAL_03",
    "employeeId": "EMP_12345",
    "employeeName": "John Doe"
  },
  "customer": {
    "name": "Jane Smith",
    "phone": "+1 555 123 4567",
    "email": "jane.smith@email.com",
    "address": "123 Main Street, Springfield",
    "notes": "Regular customer, prefers express checkout"
  },
  "items": [
    {
      "id": "PROD_001",
      "name": "Budweiser Magnum 750ML",
      "qty": 2,
      "product_price": 12.99,
      "tax_percentage": 8.5,
      "tax_amount": 2.21,
      "discount": 0,
      "subtotal": 25.98,
      "total": 28.19,
      "barcode": "1234567890123",
      "sku": "BUD-750-001",
      "category": "Beverages"
    },
    {
      "id": "PROD_045",
      "name": "Premium Organic Coffee Beans 500g",
      "qty": 1,
      "product_price": 18.50,
      "tax_percentage": 8.5,
      "tax_amount": 1.57,
      "discount": 0,
      "subtotal": 18.50,
      "total": 20.07,
      "barcode": "9876543210987",
      "sku": "COFFEE-ORG-500",
      "category": "Groceries"
    }
  ],
  "payment": {
    "method": "card",
    "subtotal": 44.48,
    "tax": 3.78,
    "discount": {
      "amount": 2.50,
      "isPercentage": false
    },
    "total": 45.76,
    "totalItems": 3,
    "cardLast4": "4242",
    "cardBrand": "Visa",
    "transactionReference": "TXN_20251211_143522_ABC123"
  },
  "receipt": {
    "emailReceipt": true,
    "printReceipt": false,
    "format": "pdf"
  }
}
```

---

## Response Schema (Expected)

```typescript
interface ReceiptGenerationResponse {
  success: boolean;
  message: string;
  data: {
    receiptId: string;              // Unique receipt identifier
    receiptNumber: string;          // Human-readable receipt number (e.g., "RCP-2025-001234")
    transactionId: string;          // Transaction identifier
    receiptUrl?: string;            // URL to download/view receipt (if stored)
    emailSent?: boolean;            // Whether email was sent successfully
    printJobId?: string;            // Print job identifier (if print requested)
    generatedAt: string;            // ISO 8601 timestamp
  };
  errors?: Array<{
    field: string;
    message: string;
  }>;
}
```

### Success Response Example
```json
{
  "success": true,
  "message": "Receipt generated successfully",
  "data": {
    "receiptId": "RCPT_ABC123XYZ789",
    "receiptNumber": "RCP-2025-001234",
    "transactionId": "TXN_20251211_143522_ABC123",
    "receiptUrl": "https://api.sellsync.com/receipts/RCPT_ABC123XYZ789.pdf",
    "emailSent": true,
    "generatedAt": "2025-12-11T14:35:25.000Z"
  }
}
```

### Error Response Example
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": [
    {
      "field": "items",
      "message": "At least one item is required"
    },
    {
      "field": "payment.total",
      "message": "Total amount must be greater than 0"
    }
  ]
}
```

---

## Validation Rules

### Required Fields
- `transaction.timestamp` - Must be valid ISO 8601 format
- `items` - Array must contain at least 1 item
- `items[].name` - Required for each item
- `items[].qty` - Must be > 0
- `items[].product_price` - Must be >= 0
- `payment.method` - Must be one of: "cash", "card", "online", "qr"
- `payment.total` - Must be > 0
- `receipt.emailReceipt` - Boolean required

### Optional Fields
- All customer fields are optional
- Transaction metadata fields (storeId, posTerminalId, etc.) are optional
- Payment fields like `tendered`, `change` are optional but recommended for cash transactions
- Card details (`cardLast4`, `cardBrand`) optional but recommended for card transactions

### Calculation Validation
Backend should verify:
- Item subtotal = qty Ã— product_price
- Item total = subtotal + tax_amount - discount
- Payment subtotal = sum of all item subtotals
- Payment total = subtotal + tax - discount.amount

---

## Implementation Notes

### Frontend Integration Point
This request will be made from the `onPay` handler in `SalePoint.jsx`:

```javascript
// Location: src/Pages/seller/SalePoint.jsx
onPay={(method, checkoutData) => {
  // Prepare receipt request here
  const receiptRequest = {
    transaction: {
      timestamp: new Date().toISOString(),
      // ... other metadata
    },
    customer: customerInfo,
    items: currentRingUpData.map(item => ({
      id: item.id,
      name: item.name,
      qty: item.qty,
      product_price: item.product_price,
      // ... calculate totals
    })),
    payment: {
      method: method,
      subtotal: subtotal,
      tax: tax,
      discount: {
        amount: discountAmount,
        isPercentage: isPercentage,
        percentage: isPercentage ? discount : undefined
      },
      total: total,
      totalItems: totalItems,
      tendered: checkoutData.tendered,
      change: checkoutData.change
    },
    receipt: {
      emailReceipt: checkoutData.emailReceipt
    }
  };
  
  // Send to backend
  // await axios.post('/api/receipts/generate', receiptRequest);
}}
```

### State Sources
- **Items**: `currentRingUpData` from Redux `RingUpSlice`
- **Customer**: `customerInfo` from `CustomerDetailsModal`
- **Payment**: `summary` object and user selections from `CheckoutModal`
- **Calculations**: Performed in `SalePoint.jsx` component

---

## Additional Considerations

### Security
- Ensure proper authentication/authorization headers
- Sanitize customer email before sending
- Validate payment amounts on backend
- Log all transactions for audit trail

### Performance
- Receipt generation should complete within 2-3 seconds
- Email sending should be asynchronous (don't block response)
- Consider queueing print jobs

### Error Handling
- Handle network failures gracefully
- Retry logic for failed email sends
- Store receipt data locally if backend is unavailable
- Provide user feedback on success/failure

---

## Change Log
- **v1.0** (2025-12-11): Initial schema definition
